<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Dashboard DEV – SmartDevs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Bem-vindo, Dev!</h1>
  </header>

  <section id="carteira">
    <h2>Carteira</h2>
    <p>Saldo disponível: R$ <span id="saldo-dev">0,00</span></p>
    <button id="btn-saque">Solicitar Saque</button>
  </section>

  <section id="historico">
    <h2>Histórico de Vendas</h2>
    <table id="tabela-vendas">
      <thead>
        <tr>
          <th>Projeto</th>
          <th>Valor Total</th>
          <th>Comissão Plataforma</th>
          <th>Saldo Dev</th>
          <th>Status Pagamento</th>
          <th>Comissão Paga</th>
          <th>Data</th>
        </tr>
      </thead>
      <tbody>
        <!-- Vendas carregadas via JS -->
      </tbody>
    </table>
  </section>

  <script src="auth.js"></script>
  <script src="main.js"></script>
  <script>
    const tabela = document.getElementById("tabela-vendas").querySelector("tbody");
    const saldoSpan = document.getElementById("saldo-dev");
    const btnSaque = document.getElementById("btn-saque");

    async function carregarVendas() {
      const { data, error } = await supabase
        .from("vendas")
        .select(`
          id,
          projeto_id,
          projetos(titulo),
          valor_total,
          comissao,
          saldo_dev,
          saldo_plataforma,
          status_pagamento,
          comissao_paga,
          data_venda
        `)
        .eq("dev_id", supabase.auth.user().id);

      if (error) return alert("Erro ao carregar vendas: " + error.message);

      // Limpar tabela
      tabela.innerHTML = "";

      // Calcular saldo total
      let saldoTotal = 0;

      data.forEach(v => {
        saldoTotal += parseFloat(v.saldo_dev);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${v.projetos.titulo}</td>
          <td>R$ ${parseFloat(v.valor_total).toFixed(2)}</td>
          <td>R$ ${parseFloat(v.comissao).toFixed(2)}</td>
          <td>R$ ${parseFloat(v.saldo_dev).toFixed(2)}</td>
          <td>${v.status_pagamento}</td>
          <td>${v.comissao_paga ? "Sim" : "Não"}</td>
          <td>${new Date(v.data_venda).toLocaleString()}</td>
        `;
        tabela.appendChild(tr);
      });

      saldoSpan.textContent = saldoTotal.toFixed(2);
    }

    btnSaque.addEventListener("click", async () => {
      if (!confirm("Deseja solicitar saque do saldo disponível?")) return;

      const { data, error } = await supabase
        .from("vendas")
        .update({ saldo_dev: 0 }) // resetar saldo após solicitar saque
        .eq("dev_id", supabase.auth.user().id)
        .eq("status_pagamento", "pago")
        .eq("comissao_paga", true);

      if (error) return alert("Erro ao solicitar saque: " + error.message);
      alert("Solicitação de saque registrada! Você receberá o valor manualmente.");
      carregarVendas();
    });

    // Inicializa
    carregarVendas();
  </script>
</body>
  </html>
