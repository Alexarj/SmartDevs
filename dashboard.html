<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Dev | SmartDevs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<header>
  <h1>Dashboard do Desenvolvedor</h1>
  <button onclick="logout()">Sair</button>
</header>

<main>

  <!-- NOVO PROJETO -->
  <section>
    <h2>Novo Projeto</h2>

    <input type="text" id="titulo" placeholder="TÃ­tulo do projeto" />
    <textarea id="descricao" placeholder="DescriÃ§Ã£o"></textarea>
    <input type="number" id="preco" placeholder="PreÃ§o (opcional)" />

    <label style="display:block;margin:10px 0;">
      <input type="checkbox" id="aceite-termos" />
      Li e aceito os <a href="termos.html" target="_blank">Termos de Uso</a>
    </label>

    <button onclick="criarProjeto()">Publicar Projeto</button>
  </section>

  <!-- MEUS PROJETOS -->
  <section>
    <h2>Meus Projetos</h2>
    <ul id="lista-projetos"></ul>
  </section>

  <!-- CONVERSAS -->
  <section>
    <h2>Conversas com Empresas</h2>
    <ul id="lista-chats"></ul>
  </section>

  <!-- CHAT -->
  <section id="chat-box" style="display:none;">
    <h2>Chat</h2>
    <div id="mensagens" style="border:1px solid #ccc;padding:10px;height:200px;overflow-y:auto;"></div>
    <textarea id="nova-mensagem" placeholder="Digite sua mensagem"></textarea>
    <button onclick="enviarMensagem()">Enviar</button>
  </section>

</main>

<script type="module" src="auth.js"></script>

<script type="module">
import { supabase, protegerPagina } from "./auth.js";

// ðŸ” proteger pÃ¡gina
await protegerPagina("dev");

const user = (await supabase.auth.getUser()).data.user;
let chatAtual = null;

// ========================
// PERFIL DEV
// ========================
const { data: perfil } = await supabase
  .from("perfis")
  .select("id")
  .single();

const devId = perfil.id;

// ========================
// ACEITE DOS TERMOS
// ========================
async function verificarAceite() {
  const { data } = await supabase
    .from("termos_aceite")
    .select("id")
    .single();
  return !!data;
}

// ========================
// CRIAR PROJETO
// ========================
window.criarProjeto = async function () {
  const titulo = document.getElementById("titulo").value;
  const descricao = document.getElementById("descricao").value;
  const preco = document.getElementById("preco").value || null;
  const aceito = document.getElementById("aceite-termos").checked;

  if (!titulo || !descricao) {
    alert("Preencha tÃ­tulo e descriÃ§Ã£o");
    return;
  }

  if (!aceito) {
    alert("Aceite os termos para publicar");
    return;
  }

  const jaAceitou = await verificarAceite();
  if (!jaAceitou) {
    await supabase.from("termos_aceite").insert({
      user_id: user.id
    });
  }

  await supabase.from("projetos").insert({
    dev_id: devId,
    titulo,
    descricao,
    preco
  });

  document.getElementById("titulo").value = "";
  document.getElementById("descricao").value = "";
  document.getElementById("preco").value = "";
  document.getElementById("aceite-termos").checked = false;

  carregarProjetos();
};

// ========================
// PROJETOS
// ========================
async function carregarProjetos() {
  const { data } = await supabase
    .from("projetos")
    .select("*")
    .eq("dev_id", devId);

  const ul = document.getElementById("lista-projetos");
  ul.innerHTML = "";

  data.forEach(p => {
    const li = document.createElement("li");
    li.innerHTML = `<strong>${p.titulo}</strong><br>${p.descricao}`;
    ul.appendChild(li);
  });
}

// ========================
// CHATS DO DEV
// ========================
async function carregarChats() {
  const { data } = await supabase
    .from("chats")
    .select(`
      id,
      projetos ( titulo ),
      perfis ( nome )
    `)
    .eq("dev_id", user.id);

  const ul = document.getElementById("lista-chats");
  ul.innerHTML = "";

  data.forEach(c => {
    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${c.projetos.titulo}</strong><br>
      Empresa: ${c.perfis.nome}<br>
      <button onclick="abrirChat('${c.id}')">Abrir Chat</button>
    `;
    ul.appendChild(li);
  });
}

// ========================
// ABRIR CHAT
// ========================
window.abrirChat = async function (chatId) {
  chatAtual = chatId;
  document.getElementById("chat-box").style.display = "block";
  carregarMensagens();
};

// ========================
// MENSAGENS
// ========================
async function carregarMensagens() {
  const { data } = await supabase
    .from("mensagens_chat")
    .select("mensagem, remetente_id")
    .eq("chat_id", chatAtual)
    .order("created_at");

  const div = document.getElementById("mensagens");
  div.innerHTML = "";

  data.forEach(m => {
    const p = document.createElement("p");
    p.textContent = m.mensagem;
    div.appendChild(p);
  });
}

// ========================
// ENVIAR MENSAGEM
// ========================
window.enviarMensagem = async function () {
  const msg = document.getElementById("nova-mensagem").value;
  if (!msg) return;

  await supabase.from("mensagens_chat").insert({
    chat_id: chatAtual,
    remetente_id: user.id,
    mensagem: msg
  });

  document.getElementById("nova-mensagem").value = "";
  carregarMensagens();
};

carregarProjetos();
carregarChats();
</script>

</body>
</html>
