<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Dev | SmartDevs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <header>
    <h1>Dashboard do Desenvolvedor</h1>
    <button onclick="logout()">Sair</button>
  </header>

  <main>
    <!-- CRIAR PROJETO -->
    <section>
      <h2>Novo Projeto</h2>
      <input type="text" id="titulo" placeholder="TÃ­tulo do projeto" />
      <textarea id="descricao" placeholder="DescriÃ§Ã£o"></textarea>
      <input type="number" id="preco" placeholder="PreÃ§o (opcional)" />
      <button onclick="criarProjeto()">Criar Projeto</button>
    </section>

    <!-- MEUS PROJETOS -->
    <section>
      <h2>Meus Projetos</h2>
      <ul id="lista-projetos"></ul>
    </section>

    <!-- CONTATOS -->
    <section>
      <h2>Contatos de Empresas</h2>
      <ul id="lista-contatos"></ul>
    </section>
  </main>

  <!-- AUTH -->
  <script type="module" src="auth.js"></script>

  <!-- DASHBOARD DEV -->
  <script type="module">
    import { supabase, protegerPagina } from "./auth.js";

    // ðŸ” proteger pÃ¡gina
    await protegerPagina("dev");

    // =========================
    // ðŸ”Ž BUSCAR PERFIL DEV
    // =========================
    const { data: perfil } = await supabase
      .from("perfis")
      .select("id")
      .single();

    const devId = perfil.id;

    // =========================
    // ðŸ“¦ CARREGAR PROJETOS
    // =========================
    async function carregarProjetos() {
      const { data } = await supabase
        .from("projetos")
        .select("*")
        .eq("dev_id", devId)
        .order("created_at", { ascending: false });

      const lista = document.getElementById("lista-projetos");
      lista.innerHTML = "";

      data.forEach(p => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${p.titulo}</strong> - ${p.descricao}`;
        lista.appendChild(li);
      });
    }

    // =========================
    // âž• CRIAR PROJETO
    // =========================
    window.criarProjeto = async function () {
      const titulo = document.getElementById("titulo").value;
      const descricao = document.getElementById("descricao").value;
      const preco = document.getElementById("preco").value || null;

      if (!titulo || !descricao) {
        alert("Preencha tÃ­tulo e descriÃ§Ã£o");
        return;
      }

      await supabase.from("projetos").insert({
        dev_id: devId,
        titulo,
        descricao,
        preco
      });

      document.getElementById("titulo").value = "";
      document.getElementById("descricao").value = "";
      document.getElementById("preco").value = "";

      carregarProjetos();
    };

    // =========================
    // ðŸ“¬ CARREGAR CONTATOS
    // =========================
    async function carregarContatos() {
      const { data } = await supabase
        .from("contatos")
        .select(`
          mensagem,
          created_at,
          projetos ( titulo ),
          perfis ( nome )
        `)
        .order("created_at", { ascending: false });

      const lista = document.getElementById("lista-contatos");
      lista.innerHTML = "";

      data.forEach(c => {
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${c.perfis.nome}</strong> 
          sobre <em>${c.projetos.titulo}</em><br/>
          ${c.mensagem}
        `;
        lista.appendChild(li);
      });
    }

    carregarProjetos();
    carregarContatos();
  </script>

</body>
</html>
