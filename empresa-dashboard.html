<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Empresa | SmartDevs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header>
  <h1>Dashboard da Empresa</h1>
  <button onclick="logout()">Sair</button>
</header>

<main>
  <section>
    <h2>Vitrine de Projetos</h2>
    <ul id="lista-projetos"></ul>
  </section>
</main>

<script type="module" src="auth.js"></script>
<script type="module">
import { supabase, protegerPagina } from "./auth.js";

await protegerPagina("empresa");
const user = (await supabase.auth.getUser()).data.user;

// Comissão 20%
const VALOR_COMISSAO = 0.20;

// LISTAR PROJETOS
async function carregarProjetos() {
  const { data } = await supabase.from("projetos")
    .select(`*, perfis(nome)`)
    .order("created_at", { ascending: false });

  const ul = document.getElementById("lista-projetos");
  ul.innerHTML = "";

  data.forEach(p => {
    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${p.titulo}</strong> - ${p.descricao} - R$ ${p.preco || 0}<br>
      Desenvolvedor: ${p.perfis.nome}<br>
      <button onclick="comprarProjeto('${p.id}', '${p.dev_id}', ${p.preco})">
        Comprar Projeto
      </button>
    `;
    ul.appendChild(li);
  });
}

async function comprarProjeto(projetoId, devId, valor) {
  if (!confirm(`Confirmar compra do projeto por R$ ${valor}?`)) return;

  const comissao = valor * VALOR_COMISSAO;

  const { error } = await supabase.from("vendas").insert({
    projeto_id: projetoId,
    dev_id: devId,
    empresa_id: user.id,
    valor_total: valor,
    comissao: comissao
  });

  if (error) return alert("Erro ao registrar venda: " + error.message);
  alert(`Compra registrada com sucesso! Comissão da plataforma: R$ ${comissao.toFixed(2)}`);
}

carregarProjetos();
</script>
</body>
</html>
