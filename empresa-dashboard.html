<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Empresa | SmartDevs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <header>
    <h1>Dashboard da Empresa</h1>
    <button onclick="logout()">Sair</button>
  </header>

  <main>
    <!-- VITRINE -->
    <section>
      <h2>Projetos Dispon√≠veis</h2>
      <ul id="lista-projetos"></ul>
    </section>

    <!-- CONTATOS -->
    <section>
      <h2>Meus Contatos Enviados</h2>
      <ul id="lista-contatos"></ul>
    </section>
  </main>

  <!-- AUTH -->
  <script type="module" src="auth.js"></script>

  <!-- DASHBOARD EMPRESA -->
  <script type="module">
    import { supabase, protegerPagina } from "./auth.js";

    // üîê proteger p√°gina
    await protegerPagina("empresa");

    // =========================
    // üîé PERFIL EMPRESA
    // =========================
    const { data: perfil } = await supabase
      .from("perfis")
      .select("id")
      .single();

    const empresaId = perfil.id;

    // =========================
    // üì¶ CARREGAR PROJETOS
    // =========================
    async function carregarProjetos() {
      const { data } = await supabase
        .from("projetos")
        .select(`
          id,
          titulo,
          descricao,
          preco,
          perfis ( nome )
        `)
        .order("created_at", { ascending: false });

      const lista = document.getElementById("lista-projetos");
      lista.innerHTML = "";

      data.forEach(p => {
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${p.titulo}</strong><br/>
          ${p.descricao}<br/>
          <em>Dev: ${p.perfis.nome}</em><br/>
          <textarea id="msg-${p.id}" placeholder="Mensagem para o desenvolvedor"></textarea><br/>
          <button onclick="enviarContato('${p.id}')">Entrar em contato</button>
        `;
        lista.appendChild(li);
      });
    }

    // =========================
    // ‚úâÔ∏è ENVIAR CONTATO
    // =========================
    window.enviarContato = async function (projetoId) {
      const mensagem = document.getElementById(`msg-${projetoId}`).value;

      if (!mensagem) {
        alert("Digite uma mensagem");
        return;
      }

      await supabase.from("contatos").insert({
        projeto_id: projetoId,
        empresa_id: empresaId,
        mensagem
      });

      alert("Mensagem enviada ao desenvolvedor!");
      carregarContatos();
    };

    // =========================
    // üì¨ MEUS CONTATOS
    // =========================
    async function carregarContatos() {
      const { data } = await supabase
        .from("contatos")
        .select(`
          mensagem,
          created_at,
          projetos ( titulo )
        `)
        .eq("empresa_id", empresaId)
        .order("created_at", { ascending: false });

      const lista = document.getElementById("lista-contatos");
      lista.innerHTML = "";

      data.forEach(c => {
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${c.projetos.titulo}</strong><br/>
          ${c.mensagem}
        `;
        lista.appendChild(li);
      });
    }

    carregarProjetos();
    carregarContatos();
  </script>

</body>
</html>
